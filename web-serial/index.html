<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">TuyaOpenä¸²å£å·¥å…·</title>
    <link rel="stylesheet" href="style.css">
    <!-- å¤šè¯­è¨€ç³»ç»Ÿå°†åœ¨é¡µé¢åº•éƒ¨åŠ è½½ -->
</head>
<body>
    <div class="container">
        <!-- Chromeæµè§ˆå™¨è¦æ±‚æé†’ -->
        <div class="browser-warning" id="browserWarning" style="display: none;">
            <div class="warning-content">
                <span class="warning-icon">âš ï¸</span>
                <span class="warning-text" data-i18n="browser_requirement">æ­¤å·¥å…·éœ€è¦Chromeå†…æ ¸æµè§ˆå™¨æ”¯æŒï¼Œå…¶ä»–æµè§ˆå™¨æ— æ³•æ­£å¸¸å·¥ä½œã€‚è¯·ä½¿ç”¨Chromeã€Edgeæˆ–å…¶ä»–åŸºäºChromiumçš„æµè§ˆå™¨ã€‚</span>
                <button class="warning-close" onclick="document.getElementById('browserWarning').style.display='none'">âœ•</button>
            </div>
        </div>

        <header>
            <div class="header-top">
                <div class="header-logo">
                    <img src="images/logo.png" alt="TuyaOpen Logo" class="logo-image">
                </div>
                <div class="language-switcher">
                    <div class="lang-dropdown" id="langDropdown">
                        <button class="lang-dropdown-btn" id="langDropdownBtn" title="åˆ‡æ¢è¯­è¨€ / Switch Language">
                            <span class="lang-flag" id="currentLangFlag">ğŸ‡¨ğŸ‡³</span>
                            <span class="lang-name" id="currentLangName">ç®€ä½“ä¸­æ–‡</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </button>
                        <div class="lang-dropdown-menu" id="langDropdownMenu">
                            <div class="lang-option" data-lang="zh">
                                <span class="lang-flag">ğŸ‡¨ğŸ‡³</span>
                                <span class="lang-name">ç®€ä½“ä¸­æ–‡</span>
                            </div>
                            <div class="lang-option" data-lang="zh-tw">
                                <span class="lang-flag">ğŸ‡¹ğŸ‡¼</span>
                                <span class="lang-name">ç¹é«”ä¸­æ–‡</span>
                            </div>
                            <div class="lang-option" data-lang="en">
                                <span class="lang-flag">ğŸ‡ºğŸ‡¸</span>
                                <span class="lang-name">English</span>
                            </div>
                            <div class="lang-option" data-lang="fr">
                                <span class="lang-flag">ğŸ‡«ğŸ‡·</span>
                                <span class="lang-name">FranÃ§ais</span>
                            </div>
                            <div class="lang-option" data-lang="de">
                                <span class="lang-flag">ğŸ‡©ğŸ‡ª</span>
                                <span class="lang-name">Deutsch</span>
                            </div>
                            <div class="lang-option" data-lang="es">
                                <span class="lang-flag">ğŸ‡ªğŸ‡¸</span>
                                <span class="lang-name">EspaÃ±ol</span>
                            </div>
                            <div class="lang-option" data-lang="ja">
                                <span class="lang-flag">ğŸ‡¯ğŸ‡µ</span>
                                <span class="lang-name">æ—¥æœ¬èª</span>
                            </div>
                            <div class="lang-option" data-lang="ko">
                                <span class="lang-flag">ğŸ‡°ğŸ‡·</span>
                                <span class="lang-name">í•œêµ­ì–´</span>
                            </div>
                            <div class="lang-option" data-lang="ru">
                                <span class="lang-flag">ğŸ‡·ğŸ‡º</span>
                                <span class="lang-name">Ğ ÑƒÑÑĞºĞ¸Ğ¹</span>
                            </div>
                            <div class="lang-option" data-lang="pt">
                                <span class="lang-flag">ğŸ‡µğŸ‡¹</span>
                                <span class="lang-name">PortuguÃªs</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h1 data-i18n="title">TuyaOpenä¸²å£å·¥å…·</h1>
            <p data-i18n="subtitle">åŸºäºChrome Web Serial APIçš„ä¸€ç«™å¼å¼€å‘è€…å·¥å…·</p>
        </header>

        <!-- Tabå¯¼èˆª -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="serial" data-i18n="tab_serial">ğŸ“¡ ä¸²å£è°ƒè¯•</button>
            <button class="tab-btn" data-tab="flash" data-i18n="tab_flash">ğŸ’¾ å›ºä»¶çƒ§å½•</button>
            <button class="tab-btn" data-tab="tuyaauth" data-i18n="tab_tuya_auth">ğŸ” TuyaOpenæˆæƒ</button>
        </div>

        <!-- Tabå†…å®¹åŒºåŸŸ -->
        <div class="tab-content">
            <!-- ä¸²å£è°ƒè¯•Tab -->
            <div id="serialTab" class="tab-panel active">
                <!-- ä¸²å£è°ƒè¯•æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <div class="control-header">
                        <h3 data-i18n="control_title">ğŸ”§ ä¸²å£è¿æ¥æ§åˆ¶</h3>
                        <div class="control-header-right" id="serialTargetDeviceContainer">
                            <div class="config-group">
                                <label for="serialTargetDevice" data-i18n="serial_target_device">ç›®æ ‡è®¾å¤‡:</label>
                                <select id="serialTargetDevice">
                                    <option value="custom" selected data-i18n="custom_device">è‡ªå®šä¹‰</option>
                                    <option value="T5AI">T5AI</option>
                                    <option value="T3">T3</option>
                                    <option value="T2">T2</option>
                                    <option value="ESP32-Series">ESP32-Series</option>
                                    <option value="BK7231N">BK7231N</option>
                                    <option value="LN882H">LN882H</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="serial-config">
                        <div class="config-group">
                            <label for="baudRate" data-i18n="baud_rate">æ³¢ç‰¹ç‡:</label>
                            <select id="baudRate">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600">57600</option>
                                <option value="115200" selected>115200</option>
                                <option value="230400">230400</option>
                                <option value="460800">460800</option>
                                <option value="921600">921600</option>
                                <option value="1152000">1152000</option>
                                <option value="1500000">1500000</option>
                                <option value="2000000">2000000</option>
                                <option value="3000000">3000000</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="dataBits" data-i18n="data_bits">æ•°æ®ä½:</label>
                            <select id="dataBits">
                                <option value="7">7</option>
                                <option value="8" selected>8</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="stopBits" data-i18n="stop_bits">åœæ­¢ä½:</label>
                            <select id="stopBits">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="parity" data-i18n="parity">æ ¡éªŒä½:</label>
                            <select id="parity">
                                <option value="none" selected data-i18n="parity_none">æ— </option>
                                <option value="even" data-i18n="parity_even">å¶æ ¡éªŒ</option>
                                <option value="odd" data-i18n="parity_odd">å¥‡æ ¡éªŒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="connection-controls">
                        <button id="connectBtn" class="btn btn-primary">
                            <span class="icon">ğŸ”—</span>
                            <span data-i18n="connect">è¿æ¥ä¸²å£</span>
                        </button>
                        <button id="disconnectBtn" class="btn btn-secondary" disabled>
                            <span class="icon"></span>
                            <span data-i18n="disconnect">æ–­å¼€è¿æ¥</span>
                        </button>
                        <div class="status-indicator">
                            <span class="status-dot" id="statusDot"></span>
                            <span id="statusText" data-i18n="status_disconnected">æœªè¿æ¥</span>
                        </div>
                        <div class="troubleshooting-link">
                            <a href="#" class="help-link" onclick="openTroubleshooting(event)">
                                <span class="icon">â“</span>
                                <span data-i18n="serial_troubleshooting">ä¸²å£æ•…éšœæ’é™¤</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®æ¥æ”¶æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="receive-data-panel">
                    <div class="data-header">
                        <h3 data-i18n="receive_data">ğŸ“¨ æ¥æ”¶æ•°æ®</h3>
                        <div class="data-controls">
                            <div class="data-controls-left">
                                <button id="clearBtn" class="btn btn-small" data-i18n="clear_log">æ¸…ç©ºæ—¥å¿—</button>
                                <button id="saveBtn" class="btn btn-small" data-i18n="save_log">ä¿å­˜æ—¥å¿—</button>
                                <label class="checkbox-container">
                                    <input type="checkbox" id="showTimestamp" checked>
                                    <span class="checkmark"></span>
                                    <span data-i18n="show_timestamp">æ˜¾ç¤ºæ—¶é—´æˆ³</span>
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" id="autoScroll" checked>
                                    <span class="checkmark"></span>
                                    <span data-i18n="auto_scroll">è‡ªåŠ¨æ»šåŠ¨</span>
                                </label>
                            </div>
                            <div class="data-controls-right">
                                <button id="fullscreenBtn" class="btn btn-small btn-fullscreen" data-i18n-title="fullscreen">
                                    <span class="icon">â›¶</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="data-display" id="dataDisplay">
                        <div class="placeholder" data-i18n="waiting_data">ç­‰å¾…ä¸²å£æ•°æ®...</div>
                    </div>
                    <div class="data-stats">
                        <span><span data-i18n="received">æ¥æ”¶</span>: <span id="rxCount">0</span> <span data-i18n="bytes">å­—èŠ‚</span></span>
                        <span><span data-i18n="sent">å‘é€</span>: <span id="txCount">0</span> <span data-i18n="bytes">å­—èŠ‚</span></span>
                    </div>
                </div>

                <!-- é”™è¯¯æ—¥å¿—åˆ†æåŒºåŸŸ -->
                <div class="error-analysis-panel">
                    <div class="data-header">
                        <div class="header-title-section">
                            <h3 data-i18n="error_analysis">é”™è¯¯æ—¥å¿—åˆ†æ</h3>
                        </div>
                        <div class="data-controls">
                            <div class="data-controls-left">
                                <button id="clearErrorAnalysisBtn" class="btn btn-small btn-secondary" data-i18n="clear_analysis">æ¸…ç©ºåˆ†æï¼ˆé‡ç½®æ£€æµ‹ï¼‰</button>
                                <label class="checkbox-container">
                                    <input type="checkbox" id="autoErrorAnalysis" checked>
                                    <span class="checkmark"></span>
                                    <span data-i18n="auto_analysis">è‡ªåŠ¨åˆ†æ</span>
                                </label>
                                <button id="testErrorAnalysisBtn" class="btn btn-small btn-debug" data-i18n="test_error_analysis">æµ‹è¯•é”™è¯¯åˆ†æ</button>
                            </div>
                            <div class="data-controls-right">
                                <button id="toggleErrorAnalysisBtn" class="btn btn-small btn-toggle collapsed" data-i18n-title="toggle_error_analysis" title="å±•å¼€/æŠ˜å é”™è¯¯åˆ†æ">
                                    <span class="toggle-icon">â–¼</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="error-analysis-content collapsed" id="errorAnalysisContent">
                        <div class="error-analysis-display" id="errorAnalysisDisplay">
                            <div class="placeholder" data-i18n="no_errors_detected">æš‚æœªæ£€æµ‹åˆ°é”™è¯¯...</div>
                        </div>
                    </div>
                </div>

                <!-- å‘é€æ•°æ®åŒºåŸŸ -->
                <div class="send-panel">
                    <div class="send-header">
                        <h3 data-i18n="send_data">ğŸ“¤ å‘é€æ•°æ®</h3>
                        <div class="send-controls">
                            <label class="checkbox-container">
                                <input type="checkbox" id="hexMode">
                                <span class="checkmark"></span>
                                <span data-i18n="hex_mode">HEXæ¨¡å¼</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" id="addNewline" checked>
                                <span class="checkmark"></span>
                                <span data-i18n="add_newline">æ·»åŠ æ¢è¡Œç¬¦</span>
                            </label>
                        </div>
                    </div>
                    <div class="send-input-area">
                        <div class="input-container">
                            <textarea 
                                id="sendInput" 
                                data-i18n-placeholder="input_placeholder"
                                placeholder="è¾“å…¥è¦å‘é€çš„æ•°æ®..."
                                rows="3"
                            ></textarea>
                            <button id="sendBtn" class="btn btn-success" disabled>
                                <span class="icon">ğŸ“¤</span>
                                <span data-i18n="send">å‘é€</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- å¿«æ·å‘é€æŒ‰é’® -->
                    <div class="quick-send">
                        <div class="quick-send-header">
                            <h4 data-i18n="quick_send">å¿«æ·å‘é€:</h4>
                            <button id="manageQuickBtn" class="btn btn-small btn-manage">
                                <span class="icon">âš™ï¸</span>
                                <span data-i18n="manage">ç®¡ç†</span>
                            </button>
                        </div>
                        <div class="quick-buttons" id="quickButtons">
                            <!-- å¿«æ·æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <div class="no-quick-commands" id="noQuickCommands" style="display: none;">
                            <p data-i18n="no_quick_commands">æš‚æ— å¿«æ·å‘½ä»¤ï¼Œç‚¹å‡»"ç®¡ç†"æŒ‰é’®æ·»åŠ </p>
                        </div>
                    </div>
                </div>
                
                <!-- æµ‹è¯•ç‰ˆæœ¬è¯´æ˜ -->
                <div class="beta-notice">
                    <div class="beta-content">
                        <span class="beta-icon">ğŸ§ª</span>
                        <span class="beta-text" data-i18n="beta_notice">å¦‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·é€šè¿‡æäº¤issueåˆ°</span>
                        <a href="https://github.com/Tuya/TuyaOpen-WebTools" target="_blank" class="beta-link" data-i18n="repository_link">TuyaOpen-WebTools ä»“åº“</a>
                    </div>
                </div>
            </div>

            <!-- å›ºä»¶çƒ§å½•Tab -->
            <div id="flashTab" class="tab-panel">
                <!-- å›ºä»¶çƒ§å½•ä¸²å£æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <div class="control-header">
                        <h3 data-i18n="control_title">ğŸ”§ ä¸²å£è¿æ¥æ§åˆ¶</h3>
                    </div>

                    <div class="serial-config">
                        <div class="config-group">
                            <label for="flashBaudRate" data-i18n="baud_rate">æ³¢ç‰¹ç‡:</label>
                            <select id="flashBaudRate">
                                <option value="115200">115200</option>
                                <option value="230400">230400</option>
                                <option value="460800">460800</option>
                                <option value="921600" selected>921600</option>
                                <option value="1152000">1152000</option>
                                <option value="1500000">1500000</option>
                                <option value="2000000">2000000</option>
                                <option value="3000000">3000000</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="flashDataBits" data-i18n="data_bits">æ•°æ®ä½:</label>
                            <select id="flashDataBits">
                                <option value="7">7</option>
                                <option value="8" selected>8</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="flashStopBits" data-i18n="stop_bits">åœæ­¢ä½:</label>
                            <select id="flashStopBits">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="flashParity" data-i18n="parity">æ ¡éªŒä½:</label>
                            <select id="flashParity">
                                <option value="none" selected data-i18n="parity_none">æ— </option>
                                <option value="even" data-i18n="parity_even">å¶æ ¡éªŒ</option>
                                <option value="odd" data-i18n="parity_odd">å¥‡æ ¡éªŒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="connection-controls">
                        <button id="connectFlashBtn" class="btn btn-primary">
                            <span class="icon">ğŸ”—</span>
                            <span data-i18n="connect">è¿æ¥ä¸²å£</span>
                        </button>
                        <button id="disconnectFlashBtn" class="btn btn-secondary" disabled>
                            <span class="icon"></span>
                            <span data-i18n="disconnect">æ–­å¼€è¿æ¥</span>
                        </button>
                        <div class="status-indicator">
                            <span class="status-dot" id="flashStatusDot"></span>
                            <span id="flashStatusText" data-i18n="status_disconnected">æœªè¿æ¥</span>
                        </div>
                        <div class="troubleshooting-link">
                            <a href="#" class="help-link" onclick="openTroubleshooting(event)">
                                <span class="icon">â“</span>
                                <span data-i18n="serial_troubleshooting">ä¸²å£æ•…éšœæ’é™¤</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- å›ºä»¶é€‰æ‹©åŒºåŸŸ -->
                <div class="flash-panel">
                    <div class="flash-header">
                        <h3 data-i18n="flash_config">ğŸ’¾ å›ºä»¶çƒ§å½•é…ç½®</h3>
                    </div>
                    
                    <div class="flash-controls">
                        <div class="config-group">
                            <label for="deviceSelect" data-i18n="target_device">ç›®æ ‡è®¾å¤‡:</label>
                            <select id="deviceSelect">
                                <option value="T5AI">T5AI</option>
                                <option value="T3">T3</option>
                                <option value="ESP32-Series" selected>ESP32-Series</option>
                                <!-- æš‚æ—¶éšè—ä»¥ä¸‹è®¾å¤‡é€‰é¡¹ï¼Œä»£ç ä¿ç•™ä»¥å¤‡åç”¨ -->
                                <!-- <option value="T2">T2</option> -->
                                <!-- <option value="BK7231N">BK7231N</option> -->
                                <!-- <option value="LN882H">LN882H</option> -->
                            </select>
                        </div>
                        <div class="config-group esp32-address-group" id="esp32AddressGroup">
                            <label for="esp32FlashAddress" data-i18n="esp32_flash_address">ESP32 Flash åœ°å€:</label>
                            <div class="address-controls">
                                <select id="esp32FlashAddress">
                                    <option value="0x0000" selected data-i18n="complete_firmware">0x0000 (å®Œæ•´å›ºä»¶åŒ…)</option>
                                    <option value="custom" data-i18n="custom_address">è‡ªå®šä¹‰åœ°å€...</option>
                                </select>
                                <input type="text" id="customAddressInput" class="custom-address-input" placeholder="0x10000" maxlength="10" data-i18n-placeholder="custom_address_placeholder">
                            </div>
                        </div>
                    </div>
                    
                    <div class="file-select-area">
                        <div class="file-input-container">
                            <input type="file" id="binFileInput" accept=".bin" style="display: none;">
                            <button id="selectFileBtn" class="btn btn-primary">
                                <span class="icon">ğŸ“</span>
                                <span data-i18n="select_file">é€‰æ‹©å›ºä»¶æ–‡ä»¶</span>
                            </button>
                            <span id="selectedFileName" class="file-name" data-i18n="no_file_selected">æœªé€‰æ‹©æ–‡ä»¶</span>
                        </div>
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <span><span data-i18n="file_size">æ–‡ä»¶å¤§å°</span>: <span id="fileSize">0</span> <span data-i18n="bytes">å­—èŠ‚</span></span>
                        </div>
                    </div>

                    <div class="download-area">
                        <button id="downloadBtn" class="btn btn-download" disabled>
                            <span class="icon">â¬‡ï¸</span>
                            <span data-i18n="start_download">å¼€å§‹çƒ§å½•</span>
                        </button>
                        <button id="stopDownloadBtn" class="btn btn-secondary" disabled>
                            <span class="icon">â¹ï¸</span>
                            <span data-i18n="stop_download">åœæ­¢çƒ§å½•</span>
                        </button>
                    </div>

                    <div class="flash-options">
                        <label class="checkbox-container">
                            <input type="checkbox" id="autoDisconnectAfterFlash">
                            <span class="checkmark"></span>
                            <span data-i18n="auto_disconnect_after_flash">å®Œæˆçƒ§å½•åè‡ªåŠ¨æ–­å¼€ä¸²å£</span>
                        </label>
                    </div>

                    <div class="progress-area" id="progressArea" style="display: none;">
                        <div class="progress-info">
                            <span id="progressText" data-i18n="preparing">å‡†å¤‡ä¸­...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-details">
                            <span><span data-i18n="downloaded">å·²çƒ§å½•</span>: <span id="downloadedBytes">0</span> / <span id="totalBytes">0</span> <span data-i18n="bytes">å­—èŠ‚</span></span>
                            <span id="flashTimer" class="flash-timer">00:00</span>
                        </div>
                    </div>
                </div>

                <!-- çƒ§å½•æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="flash-log-panel">
                    <div class="data-header">
                        <h3 data-i18n="burn_log">ğŸ“‹ çƒ§å½•æ—¥å¿—</h3>
                        <div class="data-controls">
                            <!-- è°ƒè¯•æ§åˆ¶åŒºåŸŸ -->
                            <div class="debug-controls-inline">
                                <label class="checkbox-container debug-toggle">
                                    <input type="checkbox" id="flashDebugMode">
                                    <span class="checkmark"></span>
                                    <span data-i18n="debug_mode">ğŸ”§ è°ƒè¯•æ¨¡å¼</span>
                                </label>
                            </div>
                            <button id="clearFlashLogBtn" class="btn btn-small" data-i18n="clear_log">æ¸…ç©ºæ—¥å¿—</button>
                            <button id="saveFlashLogBtn" class="btn btn-small" data-i18n="save_log">ä¿å­˜æ—¥å¿—</button>
                            <label class="checkbox-container">
                                <input type="checkbox" id="flashAutoScroll" checked>
                                <span class="checkmark"></span>
                                <span data-i18n="auto_scroll">è‡ªåŠ¨æ»šåŠ¨</span>
                            </label>
                            <button id="flashFullscreenBtn" class="btn btn-small btn-fullscreen" data-i18n-title="fullscreen">
                                <span class="icon">â›¶</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- è°ƒè¯•çŠ¶æ€æ˜¾ç¤º -->
                    <div class="debug-status-bar" id="debugStatusBar">
                        <div class="debug-status-item">
                            <span class="debug-label" data-i18n="debug_status">è°ƒè¯•çŠ¶æ€:</span>
                            <span class="debug-value" id="debugStatusValue" data-i18n="disabled">ç¦ç”¨</span>
                        </div>
                    </div>
                    
                    <div class="data-display flash-log-display" id="flashLogDisplay">
                        <div class="placeholder" data-i18n="waiting_download">ç­‰å¾…çƒ§å½•æ“ä½œ...</div>
                    </div>
                </div>
            </div>

            <!-- TuyaOpenæˆæƒTab -->
            <div id="tuyaauthTab" class="tab-panel">
                <!-- TuyaOpenæˆæƒä¸²å£æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <div class="control-header">
                        <h3 data-i18n="control_title">ğŸ”§ ä¸²å£è¿æ¥æ§åˆ¶</h3>
                    </div>

                    <div class="serial-config">
                        <div class="config-group">
                            <label for="authBaudRate" data-i18n="baud_rate">æ³¢ç‰¹ç‡:</label>
                            <select id="authBaudRate" disabled>
                                <option value="115200" selected>115200</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="authDataBits" data-i18n="data_bits">æ•°æ®ä½:</label>
                            <select id="authDataBits" disabled>
                                <option value="8" selected>8</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="authStopBits" data-i18n="stop_bits">åœæ­¢ä½:</label>
                            <select id="authStopBits" disabled>
                                <option value="1" selected>1</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="authParity" data-i18n="parity">æ ¡éªŒä½:</label>
                            <select id="authParity" disabled>
                                <option value="none" selected data-i18n="parity_none">æ— </option>
                            </select>
                        </div>
                    </div>

                    <div class="connection-controls">
                        <button id="connectAuthBtn" class="btn btn-primary">
                            <span class="icon">ğŸ”—</span>
                            <span data-i18n="connect_tuya_auth">è¿æ¥æˆæƒä¸²å£</span>
                        </button>
                        <button id="disconnectAuthBtn" class="btn btn-secondary" disabled>
                            <span class="icon"></span>
                            <span data-i18n="disconnect_tuya_auth">æ–­å¼€æˆæƒä¸²å£</span>
                        </button>
                        <div class="status-indicator">
                            <span class="status-dot" id="authStatusDot"></span>
                            <span id="authStatusText" data-i18n="status_disconnected">æœªè¿æ¥</span>
                        </div>
                        <div class="troubleshooting-link">
                            <a href="#" class="help-link" onclick="openTroubleshooting(event)">
                                <span class="icon">â“</span>
                                <span data-i18n="serial_troubleshooting">ä¸²å£æ•…éšœæ’é™¤</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- TuyaOpenæˆæƒè¾“å…¥åŒºåŸŸ -->
                <div class="tuya-auth-panel">
                    <div class="auth-header">
                        <h3 data-i18n="tuya_auth_title">ğŸ” TuyaOpenæˆæƒç å†™å…¥</h3>
                        <p class="auth-subtitle" data-i18n="tuya_auth_subtitle">å‘è®¾å¤‡å†™å…¥TuyaOpené¡¹ç›®æˆæƒä¿¡æ¯</p>
                        <div class="auth-header-right">
                            <a href="#" class="help-link" onclick="openLicenseGuide(event)">
                                <span class="icon">ğŸ“–</span>
                                <span data-i18n="license_guide">æˆæƒç è·å–æŒ‡å—</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="auth-input-area">
                        <div class="auth-form">
                            <div class="auth-form-group">
                                <label for="uuidInput" data-i18n="uuid_label">UUID (20å­—ç¬¦):</label>
                                <input 
                                    type="text" 
                                    id="uuidInput" 
                                    data-i18n-placeholder="uuid_placeholder"
                                    placeholder="è¯·è¾“å…¥20å­—ç¬¦çš„UUID..."
                                    maxlength="20"
                                    class="auth-input"
                                />
                                <div class="input-help">
                                    <span class="char-count">0/20 å­—ç¬¦</span>
                                </div>
                            </div>
                            
                            <div class="auth-form-group">
                                <label for="authKeyInput" data-i18n="auth_key_label">AUTH_KEY (32å­—ç¬¦):</label>
                                <input 
                                    type="text" 
                                    id="authKeyInput" 
                                    data-i18n-placeholder="auth_key_placeholder"
                                    placeholder="è¯·è¾“å…¥32å­—ç¬¦çš„AUTH_KEY..."
                                    maxlength="32"
                                    class="auth-input"
                                />
                                <div class="input-help">
                                    <span class="char-count">0/32 å­—ç¬¦</span>
                                </div>
                            </div>
                            
                            <div class="auth-button-area">
                                <button id="authorizeBtn" class="btn btn-success" disabled>
                                    <span class="icon">ğŸ”</span>
                                    <span data-i18n="authorize_btn">å†™å…¥æˆæƒ</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®æ¥æ”¶æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="receive-data-panel">
                    <div class="data-header">
                        <h3 data-i18n="receive_data">ğŸ“¨ æ¥æ”¶æ•°æ®</h3>
                        <div class="data-controls">
                            <div class="data-controls-left">
                                <button id="clearAuthBtn" class="btn btn-small" data-i18n="clear_log">æ¸…ç©ºæ—¥å¿—</button>
                                <button id="saveAuthBtn" class="btn btn-small" data-i18n="save_log">ä¿å­˜æ—¥å¿—</button>
                                <label class="checkbox-container">
                                    <input type="checkbox" id="authShowTimestamp" checked>
                                    <span class="checkmark"></span>
                                    <span data-i18n="show_timestamp">æ˜¾ç¤ºæ—¶é—´æˆ³</span>
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" id="authAutoScroll" checked>
                                    <span class="checkmark"></span>
                                    <span data-i18n="auto_scroll">è‡ªåŠ¨æ»šåŠ¨</span>
                                </label>
                            </div>
                            <div class="data-controls-right">
                                <button id="authFullscreenBtn" class="btn btn-small btn-fullscreen" data-i18n-title="fullscreen">
                                    <span class="icon">â›¶</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="data-display" id="authDataDisplay">
                        <div class="placeholder" data-i18n="tuya_auth_waiting">ç­‰å¾…æˆæƒæ“ä½œ...</div>
                    </div>
                    <div class="data-stats">
                        <span><span data-i18n="received">æ¥æ”¶</span>: <span id="authRxCount">0</span> <span data-i18n="bytes">å­—èŠ‚</span></span>
                        <span><span data-i18n="sent">å‘é€</span>: <span id="authTxCount">0</span> <span data-i18n="bytes">å­—èŠ‚</span></span>
                    </div>
                </div>

                <!-- é‡è¦æç¤ºåŒºåŸŸ -->
                <div class="tuya-auth-notice">
                    <div class="notice-content">
                        <h4 data-i18n="tuya_auth_notice_title">âš ï¸ é‡è¦æç¤º</h4>
                        <div class="notice-list">
                            <p data-i18n="tuya_auth_notice_content">å½“å‰æˆæƒåŠŸèƒ½åªé€‚ç”¨äºTuyaOpenå·¥ç¨‹çš„æˆæƒç å†™å…¥ï¼ŒéTuyaOpenå·¥ç¨‹æ— æ³•ä½¿ç”¨ã€‚</p>
                            <p data-i18n="tuya_auth_additional_info">è¯·ç¡®ä¿è®¾å¤‡å·²è¿›å…¥æˆæƒæ¨¡å¼ï¼Œå¹¶æ­£ç¡®è¿æ¥ä¸²å£åå†è¿›è¡Œæˆæƒæ“ä½œã€‚</p>
                        </div>
                    </div>
                </div>
                
                <!-- æµ‹è¯•ç‰ˆæœ¬è¯´æ˜ -->
                <div class="beta-notice">
                    <div class="beta-content">
                        <span class="beta-icon">ğŸ§ª</span>
                        <span class="beta-text" data-i18n="beta_notice">å½“å‰åŠŸèƒ½å±äºæµ‹è¯•ç‰ˆæœ¬ï¼Œé‡åˆ°é—®é¢˜è¯·é€šè¿‡æäº¤issueåˆ°</span>
                        <a href="https://github.com/Tuya/TuyaOpen-WebTools" target="_blank" class="beta-link" data-i18n="repository_link">TuyaOpen-WebTools ä»“åº“</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç³»ç»Ÿä¿¡æ¯ -->
    <div class="system-info-bottom">
        <p class="system-info-text" id="systemInfoSubtitle">åŠ è½½ä¸­...</p>
    </div>

    <!-- é¡µè„šç‰ˆæƒä¿¡æ¯ -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <span class="version">v0.2</span>
                <span class="separator">|</span>
                <span data-i18n="powered_by">åŸºäº</span> <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API" target="_blank">Web Serial API</a>
            </div>
            <div class="footer-right">
                <span>&copy; 2025 <a href="https://www.tuyaopen.ai/" target="_blank">TuyaOpen.ai</a></span>
                <span class="separator">|</span>
                <span data-i18n="all_rights_reserved">ä¿ç•™æ‰€æœ‰æƒåˆ©</span>
            </div>
        </div>
        
        <!-- TuyaOpené¡¹ç›®ç›¸å…³é“¾æ¥ -->
        <div class="project-links">
            <div class="project-info">
                <span class="project-title" data-i18n="project_info">è¿™ä¸ªé¡¹ç›®æ˜¯TuyaOpençš„ä¸€éƒ¨åˆ†ï¼Œç›¸å…³é¡¹ç›®åŒ…æ‹¬ï¼š</span>
            </div>
            <div class="project-list">
                <a href="https://github.com/tuya/TuyaOpen" target="_blank" class="project-link">
                    <span class="link-icon">ğŸ—ï¸</span>
                    <span data-i18n="tuya_open_project">TuyaOpen</span>
                </a>
                <a href="https://github.com/tuya/arduino-TuyaOpen" target="_blank" class="project-link">
                    <span class="link-icon">ğŸ¤–</span>
                    <span data-i18n="arduino_project">Arduino-TuyaOpen</span>
                </a>
                <a href="https://github.com/tuya/luanode-TuyaOpen" target="_blank" class="project-link">
                    <span class="link-icon">ğŸŒ™</span>
                    <span data-i18n="lua_project">Luanode-TuyaOpen</span>
                </a>
                <a href="https://github.com/Tuya/TuyaOpen-WebTools" target="_blank" class="project-link">
                    <span class="link-icon">ğŸ”§</span>
                    <span data-i18n="tools_project">TuyaOpen-WebTools</span>
                </a>
            </div>
        </div>
    </footer>

    <!-- å…¨å±æ˜¾ç¤ºè¦†ç›–å±‚ -->
    <div id="fullscreenOverlay" class="fullscreen-overlay">
        <div class="fullscreen-header">
            <h3 data-i18n="receive_data">ğŸ“¨ æ¥æ”¶æ•°æ®</h3>
            <button id="fullscreenCloseBtn" class="fullscreen-close" data-i18n-title="exit_fullscreen">
                <span class="icon">âœ•</span>
            </button>
        </div>
        <div id="fullscreenDataDisplay" class="fullscreen-data-display">
            <div class="placeholder" data-i18n="waiting_data">ç­‰å¾…ä¸²å£æ•°æ®...</div>
        </div>
    </div>

    <!-- çƒ§å½•æ—¥å¿—å…¨å±æ˜¾ç¤ºè¦†ç›–å±‚ -->
    <div id="flashFullscreenOverlay" class="fullscreen-overlay">
        <div class="fullscreen-header">
            <h3 data-i18n="burn_log">ğŸ“‹ çƒ§å½•æ—¥å¿—</h3>
            <button id="flashFullscreenCloseBtn" class="fullscreen-close" data-i18n-title="exit_fullscreen">
                <span class="icon">âœ•</span>
            </button>
        </div>
        <div id="flashFullscreenDataDisplay" class="fullscreen-data-display">
            <div class="placeholder" data-i18n="waiting_download">ç­‰å¾…çƒ§å½•æ“ä½œ...</div>
        </div>
    </div>

    <!-- æˆæƒæ—¥å¿—å…¨å±æ˜¾ç¤ºè¦†ç›–å±‚ -->
    <div id="authFullscreenOverlay" class="fullscreen-overlay">
        <div class="fullscreen-header">
            <h3 data-i18n="receive_data">ğŸ“¨ æ¥æ”¶æ•°æ®</h3>
            <button id="authFullscreenCloseBtn" class="fullscreen-close" data-i18n-title="exit_fullscreen">
                <span class="icon">âœ•</span>
            </button>
        </div>
        <div id="authFullscreenDataDisplay" class="fullscreen-data-display">
            <div class="placeholder" data-i18n="tuya_auth_waiting">ç­‰å¾…æˆæƒæ“ä½œ...</div>
        </div>
    </div>

    <!-- é”™è¯¯æç¤ºæ¨¡æ€æ¡† -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 data-i18n="error">âŒ é”™è¯¯</h3>
            <p id="errorMessage"></p>
        </div>
    </div>

    <!-- å¿«æ·å‘é€ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="quickCommandModal" class="modal">
        <div class="modal-content quick-command-modal">
            <span class="close">&times;</span>
            <h3 data-i18n="quick_send_management">âš™ï¸ å¿«æ·å‘é€ç®¡ç†</h3>
            
            <!-- æ·»åŠ æ–°å‘½ä»¤ -->
            <div class="add-command-section">
                <h4 data-i18n="add_new_command">æ·»åŠ æ–°å‘½ä»¤</h4>
                <div class="command-form">
                    <div class="form-group">
                        <label for="commandName" data-i18n="display_name">æ˜¾ç¤ºåç§°:</label>
                        <input type="text" id="commandName" data-i18n-placeholder="name_example" placeholder="ä¾‹å¦‚: å¤ä½" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="commandValue" data-i18n="send_content">å‘é€å†…å®¹:</label>
                        <input type="text" id="commandValue" data-i18n-placeholder="content_example" placeholder="ä¾‹å¦‚: AT+RST">
                    </div>
                    <button id="addCommandBtn" class="btn btn-primary btn-small">
                        <span class="icon">â•</span>
                        <span data-i18n="add">æ·»åŠ </span>
                    </button>
                </div>
            </div>
            
            <!-- å‘½ä»¤åˆ—è¡¨ -->
            <div class="command-list-section">
                <h4 data-i18n="existing_commands">å·²æœ‰å‘½ä»¤</h4>
                <div class="command-list" id="commandList">
                    <!-- å‘½ä»¤é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="no-commands" id="noCommands" style="display: none;">
                    <p data-i18n="no_commands">æš‚æ— å¿«æ·å‘½ä»¤</p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="resetDefaultBtn" class="btn btn-secondary btn-small">
                    <span class="icon">ğŸ”„</span>
                    <span data-i18n="reset_default">æ¢å¤é»˜è®¤</span>
                </button>
                <button id="closeQuickModalBtn" class="btn btn-primary" data-i18n="close">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¤šè¯­è¨€é…ç½®æ–‡ä»¶ -->
    <script src="i18n/loader.js"></script>
    
    <!-- ä¸»è¦åŠŸèƒ½è„šæœ¬ -->
    <script src="script-clean.js"></script>
    
    <!-- ESP32 esptool-js åº“ -->
    <!-- ğŸ”§ CryptoJSåº“åŠ è½½ - CDN + æœ¬åœ°å¤‡ç”¨æ–¹æ¡ˆ -->
    <script>
        // ç³»ç»Ÿæ€§ä¿®å¤CryptoJSåŠ è½½é—®é¢˜
        (function() {
            console.log('ğŸ” å¼€å§‹åŠ è½½CryptoJSåº“...');
            
            // åˆ›å»ºCDNè„šæœ¬æ ‡ç­¾
            const cdnScript = document.createElement('script');
            cdnScript.src = 'https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js';
            cdnScript.async = false; // åŒæ­¥åŠ è½½ï¼Œç¡®ä¿æŒ‰é¡ºåºæ‰§è¡Œ
            
            // CDNåŠ è½½æˆåŠŸ
            cdnScript.onload = function() {
                console.log('âœ… CryptoJSåº“CDNåŠ è½½æˆåŠŸ');
                window.cryptoJSLoaded = true;
            };
            
            // CDNåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ç”¨
            cdnScript.onerror = function() {
                console.warn('âš ï¸ CryptoJSåº“CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•æœ¬åœ°å¤‡ç”¨åº“...');
                
                const localScript = document.createElement('script');
                localScript.src = 'third_party/crypto-js.min.js';
                localScript.async = false;
                
                localScript.onload = function() {
                    console.log('âœ… CryptoJSæœ¬åœ°å¤‡ç”¨åº“åŠ è½½æˆåŠŸ');
                    window.cryptoJSLoaded = true;
                };
                
                localScript.onerror = function() {
                    console.error('âŒ CryptoJSæœ¬åœ°å¤‡ç”¨åº“ä¹ŸåŠ è½½å¤±è´¥');
                    console.error('ğŸ’¡ ESP32çƒ§å½•å°†ä½¿ç”¨å¤‡ç”¨å“ˆå¸Œç®—æ³•ï¼Œä¸ä¼šå½±å“åŸºæœ¬åŠŸèƒ½');
                    window.cryptoJSLoaded = false;
                };
                
                document.head.appendChild(localScript);
            };
            
            // å¼€å§‹åŠ è½½CDNè„šæœ¬
            document.head.appendChild(cdnScript);
            
            // è®¾ç½®è¶…æ—¶æ£€æŸ¥
            setTimeout(function() {
                if (typeof window.CryptoJS === 'undefined') {
                    console.warn('âš ï¸ CryptoJSåº“åŠ è½½è¶…æ—¶ï¼ŒESP32çƒ§å½•å°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                    window.cryptoJSLoaded = false;
                }
            }, 5000);
        })();
    </script>
    <script src="third_party/esptool-js-umd.bundle.js"></script>
    
    <!-- ä¸‹è½½å™¨è„šæœ¬ -->
    <script src="flash-downloader.js"></script>
    <script src="downloaders/base-downloader.js"></script>
    <script src="downloaders/t5ai/T5AISignalController.js"></script> <!-- T5AIä¿¡å·æ§åˆ¶å™¨ -->
    <script src="downloaders/t5ai/T5AISignalControllerTester.js"></script> <!-- T5AIä¿¡å·æ§åˆ¶å™¨æµ‹è¯•å·¥å…· -->
    <script src="downloaders/esp32/esp32-esptool-js-wrapper.js"></script>
    <script src="downloaders/downloader-manager.js"></script>
    <script src="ubuntu-baudrate-patch.js"></script> <!-- Ubuntuæ³¢ç‰¹ç‡å…¼å®¹æ€§è¡¥ä¸ -->
    
    <!-- åˆå§‹åŒ–å¤šè¯­è¨€ç³»ç»Ÿå’Œäº‹ä»¶å¤„ç† -->
    <script>
        // æ‰“å¼€æ•…éšœæ’é™¤é¡µé¢ï¼Œä¼ é€’å½“å‰è¯­è¨€å‚æ•°
        function openTroubleshooting(event) {
            event.preventDefault();
            const currentLang = localStorage.getItem('selectedLanguage') || 'zh';
            window.open(`troubleshooting.html?lang=${currentLang}`, '_blank');
        }
        
        // æ‰“å¼€æˆæƒç è·å–æŒ‡å—é¡µé¢ï¼Œä¼ é€’å½“å‰è¯­è¨€å‚æ•°
        function openLicenseGuide(event) {
            event.preventDefault();
            const currentLang = localStorage.getItem('selectedLanguage') || 'zh';
            window.open(`authorization.html?lang=${currentLang}`, '_blank');
        }
        
        // æ›´æ–°è¯­è¨€æ˜¾ç¤º
        function updateLanguageDisplay(lang) {
            const flagElement = document.getElementById('currentLangFlag');
            const nameElement = document.getElementById('currentLangName');
            
            if (flagElement && nameElement) {
                flagElement.textContent = getFlagEmoji(lang);
                
                // è·å–è¯­è¨€åç§°
                const langNames = {
                    'zh': 'ç®€ä½“ä¸­æ–‡',
                    'zh-tw': 'ç¹é«”ä¸­æ–‡', 
                    'en': 'English',
                    'fr': 'FranÃ§ais',
                    'de': 'Deutsch',
                    'es': 'EspaÃ±ol',
                    'ja': 'æ—¥æœ¬èª',
                    'ko': 'í•œêµ­ì–´',
                    'ru': 'Ğ ÑƒÑÑĞºĞ¸Ğ¹',
                    'pt': 'PortuguÃªs'
                };
                nameElement.textContent = langNames[lang] || 'ç®€ä½“ä¸­æ–‡';
            }
            
            // æ›´æ–°è¯­è¨€é€‰é¡¹çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.lang-option').forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-lang') === lang) {
                    option.classList.add('active');
                }
            });
        }
        
        function getFlagEmoji(lang) {
            const flagMap = {
                'zh': 'ğŸ‡¨ğŸ‡³',
                'zh-tw': 'ğŸ‡¹ğŸ‡¼',
                'en': 'ğŸ‡ºğŸ‡¸',
                'fr': 'ğŸ‡«ğŸ‡·',
                'de': 'ğŸ‡©ğŸ‡ª',
                'es': 'ğŸ‡ªğŸ‡¸',
                'ja': 'ğŸ‡¯ğŸ‡µ',
                'ko': 'ğŸ‡°ğŸ‡·',
                'ru': 'ğŸ‡·ğŸ‡º',
                'pt': 'ğŸ‡µğŸ‡¹'
            };
            return flagMap[lang] || 'ğŸŒ';
        }
        
        // è¯­è¨€ä¸‹æ‹‰èœå•çŠ¶æ€
        let isDropdownOpen = false;
        
        // åˆ‡æ¢ä¸‹æ‹‰èœå•
        function toggleLanguageDropdown() {
            const langDropdown = document.getElementById('langDropdown');
            const langDropdownMenu = document.getElementById('langDropdownMenu');
            
            if (!langDropdown || !langDropdownMenu) {
                console.error('è¯­è¨€ä¸‹æ‹‰èœå•å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            isDropdownOpen = !isDropdownOpen;
            
            if (isDropdownOpen) {
                // æ‰“å¼€èœå•
                langDropdown.classList.add('active');
                console.log('è¯­è¨€ä¸‹æ‹‰èœå•å·²æ‰“å¼€');
            } else {
                // å…³é—­èœå•
                langDropdown.classList.remove('active');
                console.log('è¯­è¨€ä¸‹æ‹‰èœå•å·²å…³é—­');
            }
        }
        
        // å…³é—­ä¸‹æ‹‰èœå•
        function closeLanguageDropdown() {
            const langDropdown = document.getElementById('langDropdown');
            if (langDropdown) {
                langDropdown.classList.remove('active');
                isDropdownOpen = false;
                console.log('è¯­è¨€ä¸‹æ‹‰èœå•å·²å…³é—­');
            }
        }
        
        // é€‰æ‹©è¯­è¨€
        function selectLanguage(langCode) {
            console.log('é€‰æ‹©è¯­è¨€:', langCode);
            
            // å…³é—­ä¸‹æ‹‰èœå•
            closeLanguageDropdown();
            
            // åˆ‡æ¢è¯­è¨€
            if (window.i18nLoader && typeof window.i18nLoader.setLanguage === 'function') {
                window.i18nLoader.setLanguage(langCode).then(() => {
                    console.log('è¯­è¨€åˆ‡æ¢æˆåŠŸ:', langCode);
                }).catch(error => {
                    console.error('è¯­è¨€åˆ‡æ¢å¤±è´¥:', error);
                });
            } else {
                console.error('i18nLoaderæœªåˆå§‹åŒ–æˆ–setLanguageæ–¹æ³•ä¸å­˜åœ¨');
            }
        }
        
        // åˆå§‹åŒ–è¯­è¨€ä¸‹æ‹‰èœå•
        function initLanguageDropdown() {
            console.log('å¼€å§‹åˆå§‹åŒ–è¯­è¨€ä¸‹æ‹‰èœå•...');
            
            const langDropdownBtn = document.getElementById('langDropdownBtn');
            const langDropdown = document.getElementById('langDropdown');
            
            if (!langDropdownBtn || !langDropdown) {
                console.error('è¯­è¨€ä¸‹æ‹‰èœå•å…ƒç´ æœªæ‰¾åˆ°:', {
                    btn: !!langDropdownBtn,
                    dropdown: !!langDropdown
                });
                return;
            }
            
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            langDropdownBtn.replaceWith(langDropdownBtn.cloneNode(true));
            const newBtn = document.getElementById('langDropdownBtn');
            
            // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('è¯­è¨€ä¸‹æ‹‰æŒ‰é’®è¢«ç‚¹å‡»');
                toggleLanguageDropdown();
            });
            
            // ä¸ºæ¯ä¸ªè¯­è¨€é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.lang-option').forEach(option => {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                const newOption = option.cloneNode(true);
                option.parentNode.replaceChild(newOption, option);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                newOption.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const selectedLang = this.getAttribute('data-lang');
                    selectLanguage(selectedLang);
                });
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', function(event) {
                const langDropdown = document.getElementById('langDropdown');
                if (langDropdown && !langDropdown.contains(event.target)) {
                    closeLanguageDropdown();
                }
            });
            
            console.log('è¯­è¨€ä¸‹æ‹‰èœå•åˆå§‹åŒ–å®Œæˆ');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            try {
                // å…ˆåˆå§‹åŒ–å¤šè¯­è¨€ç³»ç»Ÿ
                if (window.i18nLoader) {
                    console.log('å¼€å§‹åˆå§‹åŒ–å¤šè¯­è¨€ç³»ç»Ÿ...');
                    await window.i18nLoader.init();
                    console.log('å¤šè¯­è¨€ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                } else {
                    console.error('i18nLoaderæœªæ‰¾åˆ°');
                }
                
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
                setTimeout(() => {
                    // åˆå§‹åŒ–è¯­è¨€ä¸‹æ‹‰èœå•
                    initLanguageDropdown();
                }, 100);
                
                // ç„¶ååˆå§‹åŒ–ä¸²å£ç»ˆç«¯ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–çš„è¯ï¼‰
                if (!window.serialTerminal && typeof SerialTerminal !== 'undefined') {
                    window.serialTerminal = new SerialTerminal();
                    console.log('ä¸²å£ç»ˆç«¯åˆå§‹åŒ–å®Œæˆ');
                    
                    // åˆå§‹åŒ–åç«‹å³æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
                    window.serialTerminal.updateSystemInfoDisplay();
                }
            } catch (error) {
                console.error('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
        
        // ç›‘å¬å¤šè¯­è¨€ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆäº‹ä»¶
        window.addEventListener('i18nReady', function(event) {
            const currentLang = event.detail.language;
            updateLanguageDisplay(currentLang);
            if (window.serialTerminal && typeof window.serialTerminal.updateSystemInfoDisplay === 'function') {
                window.serialTerminal.updateSystemInfoDisplay();
            }
            console.log('ä¸»é¡µå¤šè¯­è¨€ç³»ç»Ÿå°±ç»ªï¼Œå½“å‰è¯­è¨€:', currentLang);
        });
        
        // ç›‘å¬è¯­è¨€å˜æ›´äº‹ä»¶
        window.addEventListener('languageChanged', function(event) {
            const currentLang = event.detail.language;
            updateLanguageDisplay(currentLang);  // æ›´æ–°è¯­è¨€é€‰æ‹©å™¨æ˜¾ç¤º
            if (window.serialTerminal && typeof window.serialTerminal.updateSystemInfoDisplay === 'function') {
                window.serialTerminal.updateSystemInfoDisplay();
            }
        });
        window.addEventListener('globalLanguageChanged', function(event) {
            if (window.serialTerminal && typeof window.serialTerminal.updateSystemInfoDisplay === 'function') {
                window.serialTerminal.updateSystemInfoDisplay();
            }
        });
        
        // ESP32ä¸“ç”¨å›ºä»¶ä¸‹è½½ç®¡ç†å™¨
        // ä¸å½±å“ç°æœ‰T5AI/T3é€»è¾‘ï¼Œä¸“æ³¨äºESP32ä¼˜åŒ–
        class ESP32FlashManager {
            constructor() {
                this.downloader = null;
                this.isConnected = false;
                this.chipInfo = null;
                this.serialPort = null;
                this.isDownloading = false;
                
                // åªåœ¨å›ºä»¶ä¸‹è½½Tabé¡µé¢åˆå§‹åŒ–
                if (document.getElementById('flashTab')) {
                    this.initializeESP32Events();
                }
            }
            
            initializeESP32Events() {
                // åªå¤„ç†ESP32ç›¸å…³çš„äº‹ä»¶ï¼Œä¸å½±å“T5AI/T3
                const deviceSelect = document.getElementById('deviceSelect');
                if (!deviceSelect) {
                    console.error('deviceSelect element not found');
                    return;
                }
                
                // ç›‘å¬è®¾å¤‡é€‰æ‹©å˜åŒ–
                deviceSelect.addEventListener('change', (e) => {
                    if (this.isESP32Device(e.target.value)) {
                        this.enableESP32Features();
                    } else {
                        this.disableESP32Features();
                    }
                });
                
                // ESP32åœ°å€é€‰æ‹©äº‹ä»¶
                const esp32AddressSelect = document.getElementById('esp32FlashAddress');
                const customAddressInput = document.getElementById('customAddressInput');
                
                if (esp32AddressSelect) {
                    esp32AddressSelect.addEventListener('change', (e) => {
                        if (e.target.value === 'custom') {
                            if (customAddressInput) {
                                customAddressInput.classList.add('show');
                                customAddressInput.focus();
                            }
                        } else {
                            if (customAddressInput) {
                                customAddressInput.classList.remove('show');
                            }
                        }
                        this.logESP32(`ESP32ä¸‹è½½åœ°å€å·²é€‰æ‹©: ${this.getESP32FlashAddress()}`, 'info');
                    });
                    
                    // è‡ªå®šä¹‰åœ°å€è¾“å…¥éªŒè¯
                    if (customAddressInput) {
                        customAddressInput.addEventListener('input', (e) => {
                            let value = e.target.value.trim();
                            // è‡ªåŠ¨æ·»åŠ 0xå‰ç¼€
                            if (value && !value.startsWith('0x')) {
                                value = '0x' + value;
                                e.target.value = value;
                            }
                            // éªŒè¯åå…­è¿›åˆ¶æ ¼å¼
                            if (value && !/^0x[0-9a-fA-F]+$/.test(value)) {
                                e.target.classList.add('error');
                                e.target.classList.remove('valid');
                            } else {
                                e.target.classList.remove('error');
                                if (value) {
                                    e.target.classList.add('valid');
                                } else {
                                    e.target.classList.remove('valid');
                                }
                            }
                        });
                    }
                }
                
                // åˆå§‹çŠ¶æ€æ£€æŸ¥
                if (this.isESP32Device(deviceSelect.value)) {
                    this.enableESP32Features();
                }
            }
            
            isESP32Device(deviceType) {
                return ['ESP32-Series'].includes(deviceType);
            }
            
            enableESP32Features() {
                // æ˜¾ç¤ºESP32åœ°å€é…ç½®
                const esp32AddressGroup = document.getElementById('esp32AddressGroup');
                if (esp32AddressGroup) {
                    esp32AddressGroup.classList.add('show');
                    
                    // å¼ºåˆ¶æ›´æ–°æ–°æ˜¾ç¤ºå…ƒç´ çš„å¤šè¯­è¨€æ–‡æœ¬
                    setTimeout(() => {
                        if (window.i18nLoader) {
                            window.i18nLoader.updatePageText();
                        }
                    }, 50);
                }
                this.logESP32(`ESP32è®¾å¤‡å·²é€‰æ‹©ï¼Œä¸‹è½½åœ°å€: ${this.getESP32FlashAddress()}`, 'info');
            }
            
            disableESP32Features() {
                // éšè—ESP32åœ°å€é…ç½®
                const esp32AddressGroup = document.getElementById('esp32AddressGroup');
                const customAddressInput = document.getElementById('customAddressInput');
                if (esp32AddressGroup) {
                    esp32AddressGroup.classList.remove('show');
                }
                if (customAddressInput) {
                    customAddressInput.classList.remove('show');
                }
            }
            
            getESP32FlashAddress() {
                const esp32AddressSelect = document.getElementById('esp32FlashAddress');
                const customAddressInput = document.getElementById('customAddressInput');
                
                if (!esp32AddressSelect) {
                    return 0x10000; // é»˜è®¤åœ°å€
                }
                
                const selectedValue = esp32AddressSelect.value;
                
                if (selectedValue === 'custom') {
                    const customValue = customAddressInput ? customAddressInput.value.trim() : '';
                    if (customValue && /^0x[0-9a-fA-F]+$/.test(customValue)) {
                        return parseInt(customValue, 16);
                    } else {
                        this.logESP32('âš ï¸ è‡ªå®šä¹‰åœ°å€æ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤åœ°å€0x10000', 'warning');
                        return 0x10000;
                    }
                } else {
                    return parseInt(selectedValue, 16);
                }
            }
            

            
            logESP32(message, type = 'info') {
                try {
                    // åªåœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
                    const debugModeCheckbox = document.getElementById('flashDebugMode');
                    const debugMode = debugModeCheckbox ? debugModeCheckbox.checked : false;
                    
                    if (!debugMode && type === 'debug') {
                        return; // éè°ƒè¯•æ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºdebugæ—¥å¿—
                    }
                    
                    const logDisplay = document.getElementById('flashLogDisplay');
                    if (!logDisplay) {
                        console.log('[ESP32]', message); // å¤‡ç”¨æ—¥å¿—
                        return;
                    }
                    
                    const timestamp = new Date().toLocaleTimeString();
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                
                let icon = 'ğŸ“';
                switch (type) {
                    case 'success': icon = 'âœ…'; break;
                    case 'error': icon = 'âŒ'; break;
                    case 'warning': icon = 'âš ï¸'; break;
                    case 'debug': icon = 'ğŸ”'; break;
                    case 'info': 
                    default: icon = 'â„¹ï¸'; break;
                }
                
                logEntry.innerHTML = 
                    '<span class="log-time">[' + timestamp + ']</span>' +
                    '<span class="log-icon">' + icon + '</span>' +
                    '<span class="log-message">' + message + '</span>';
                
                // æ¸…é™¤å ä½ç¬¦
                if (logDisplay.querySelector('.placeholder')) {
                    logDisplay.innerHTML = '';
                }
                
                logDisplay.appendChild(logEntry);
                
                // è‡ªåŠ¨æ»šåŠ¨
                const autoScrollCheckbox = document.getElementById('flashAutoScroll');
                if (autoScrollCheckbox && autoScrollCheckbox.checked) {
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                }
                } catch (error) {
                    console.error('logESP32 error:', error);
                    console.log('[ESP32]', message); // å¤‡ç”¨æ—¥å¿—
                }
            }
        }
        
        // åˆå§‹åŒ–ESP32ç®¡ç†å™¨ï¼ˆä¸å½±å“ç°æœ‰åˆå§‹åŒ–æµç¨‹ï¼‰
        window.addEventListener('DOMContentLoaded', () => {
            // ç¡®ä¿esptool-jsåº“åŠ è½½å®Œæˆåå†åˆå§‹åŒ–ESP32ç®¡ç†å™¨
            const waitForEsptoolJs = () => {
                if (typeof window.esptooljs !== 'undefined' && window.esptooljs.ESPLoader) {
                    if (document.getElementById('flashTab')) {
                        window.esp32FlashManager = new ESP32FlashManager();
                        console.log('ESP32å›ºä»¶ä¸‹è½½ç®¡ç†å™¨å·²åˆå§‹åŒ– (esptool-jså·²å°±ç»ª)');
                    }
                } else {
                    // å¦‚æœesptool-jsè¿˜æ²¡åŠ è½½å®Œï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å†è¯•
                    setTimeout(waitForEsptoolJs, 100);
                }
            };
            
            // å»¶è¿Ÿå¯åŠ¨ï¼Œç¡®ä¿å…¶ä»–è„šæœ¬éƒ½åŠ è½½å®Œ
            setTimeout(waitForEsptoolJs, 500);
        });
    </script>
</body>
</html>